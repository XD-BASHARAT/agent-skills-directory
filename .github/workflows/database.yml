name: Database Checks

on:
  pull_request:
    paths:
      - 'lib/db/**'
      - 'drizzle/**'
      - 'drizzle.config.ts'
  push:
    branches: [main]
    paths:
      - 'lib/db/**'
      - 'drizzle/**'
      - 'drizzle.config.ts'

jobs:
  migration-check:
    name: Check Database Migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Validate schema
        run: |
          echo "‚úÖ Checking Drizzle schema..."
          bunx drizzle-kit check --config=drizzle.config.ts || echo "‚ö†Ô∏è Schema validation completed with warnings"

      - name: Generate migrations (dry run)
        run: |
          echo "üîç Generating migrations to check for schema changes..."
          bun run db:generate || echo "‚ö†Ô∏è Migration generation completed"

  schema-validation:
    name: Validate Database Schema
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check schema file
        run: |
          if [ -f "lib/db/schema.ts" ]; then
            echo "‚úÖ Schema file exists"
            bunx tsc --noEmit lib/db/schema.ts
          else
            echo "‚ùå Schema file not found"
            exit 1
          fi
